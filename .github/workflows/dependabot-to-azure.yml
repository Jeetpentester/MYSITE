name: Sync Dependabot Alerts to Azure Boards

on:
  workflow_dispatch:     # Allows manual trigger
  schedule:
    - cron: '0 */6 * * *'  # Runs every 6 hours

jobs:
  sync_dependabot_alerts:
    runs-on: ubuntu-latest

    steps:
      - name: üß™ Fetch Dependabot Alerts
        env:
          GH_TOKEN: ${{ secrets.GH_DEPENDABOT_PAT }}
          GH_REPO: ${{ github.repository }}
        run: |
          echo "üîê Using token to fetch alerts from $GH_REPO"

          curl -s -H "Authorization: token $GH_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/repos/$GH_REPO/dependabot/alerts?state=open" \
               -o alerts.json

          echo "üì¶ Raw alerts.json:"
          cat alerts.json

          echo "‚úÖ Parsing test (first item):"
          jq -c '.[0]' alerts.json || echo "‚ö†Ô∏è No alerts or invalid format"

      - name: üîÅ Create Azure Boards Tasks from Alerts
        env:
          AZURE_ORG_URL: https://dev.azure.com/devsecopsjeet
          AZURE_PROJECT: MYSITE
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
        run: |
          echo "üì§ Looping through Dependabot alerts..."

          cat alerts.json | jq -c '.[]' | while read -r alert; do
            SEVERITY=$(echo "$alert" | jq -r '.security_advisory.severity')
            PACKAGE=$(echo "$alert" | jq -r '.dependency.package.name')
            IDENTIFIER=$(echo "$alert" | jq -r '.security_advisory.ghsa_id')
            DESC=$(echo "$alert" | jq -r '.security_advisory.summary')
            URL=$(echo "$alert" | jq -r '.html_url')

            TITLE="‚ö†Ô∏è $SEVERITY vulnerability in $PACKAGE ($IDENTIFIER)"

            echo "‚û°Ô∏è Creating task: $TITLE"

            AUTH_HEADER=$(echo -n ":$AZURE_DEVOPS_PAT" | base64 | tr -d '\n')

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$AZURE_ORG_URL/$AZURE_PROJECT/_apis/wit/workitems/\$Task?api-version=7.0" \
              -H "Content-Type: application/json-patch+json" \
              -H "Authorization: Basic $AUTH_HEADER" \
              -d "[{
                    \"op\": \"add\",
                    \"path\": \"/fields/System.Title\",
                    \"value\": \"$TITLE\"
                  },{
                    \"op\": \"add\",
                    \"path\": \"/fields/System.Description\",
                    \"value\": \"GitHub Dependabot alert: <a href='$URL'>$URL</a><br/><br/>$DESC\"
                  }]")

            STATUS=$(echo "$RESPONSE" | tail -n1)
            if [[ "$STATUS" == "200" || "$STATUS" == "201" ]]; then
              echo "‚úÖ Task created for $PACKAGE"
            else
              echo "‚ùå Failed to create task. Status: $STATUS"
              echo "$RESPONSE" | sed '$d'
            fi
          done